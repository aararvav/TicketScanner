<!DOCTYPE html>
<html>
<head>
  <title>Events - Ticket Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="/static/css/main.css" rel="stylesheet" />
  <style>
    .events-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .events-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }
    
    .event-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    .event-card:hover {
      transform: translateY(-4px);
      border-color: #667eea;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    }
    
    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .event-title {
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .event-date {
      color: var(--text-secondary);
      font-size: var(--text-sm);
    }
    
    .event-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      text-align: center;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    
    .stat-number {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: var(--text-xs);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .event-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .btn-event {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }
    
    .btn-event.primary {
      background: var(--primary-gradient);
      color: white;
    }
    
    .btn-event.secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-event:hover {
      transform: translateY(-2px);
      text-decoration: none;
    }
    
    .btn-event.primary:hover {
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-event.secondary:hover {
      color: var(--text-primary);
      border-color: #667eea;
    }
    
    .create-event-form {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      border: 1px solid var(--border-color);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .events-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .event-actions {
        justify-content: center;
      }
    }

    /* Edit Event Modal Styles */
    #editEventModal .modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
      position: relative;
    }

    #editEventModal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 24px;
    }

    #editEventModal .modal-header h2 {
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    #editEventModal .modal-header h2 i {
      color: #667eea;
      margin-right: 12px;
    }

    #editEventModal .close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    #editEventModal .close-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    #editEventModal .modal-body {
      padding: 0 24px 24px;
    }

    #editEventModal .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    #editEventModal .form-group {
      margin-bottom: 16px;
    }

    #editEventModal .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }

    #editEventModal .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.3s ease;
    }

    #editEventModal .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #editEventModal .text-center {
      text-align: center;
      margin-top: 24px;
    }

    #editEventModal .btn-modern {
      margin: 0 8px;
    }

    @media (max-width: 768px) {
      #editEventModal .form-row {
        grid-template-columns: 1fr;
      }
      
      #editEventModal .modal-content {
        width: 95%;
        margin: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <i class="fas fa-ticket-alt"></i>
        <span>TicketScanner</span>
      </div>
      
      <nav class="sidebar-nav">
        <a href="/dashboard" class="nav-item">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
        <a href="/scan" class="nav-item">
          <i class="fas fa-qrcode"></i>
          <span>Scan QR</span>
        </a>
        <a href="/add" class="nav-item">
          <i class="fas fa-plus"></i>
          <span>Add Ticket</span>
        </a>
        <a href="/list" class="nav-item">
          <i class="fas fa-list"></i>
          <span>Guest List</span>
        </a>
        <a href="/events" class="nav-item active">
          <i class="fas fa-calendar"></i>
          <span>Events</span>
        </a>
        <a href="/stats" class="nav-item">
          <i class="fas fa-chart-bar"></i>
          <span>Analytics</span>
        </a>
        <a href="/settings" class="nav-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
        <a href="/logout" class="nav-item">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'error' if category == 'error' else category }} animate-fade-in">
              <i class="fas fa-{{ 'exclamation-circle' if category == 'error' else 'check-circle' }}"></i>
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="events-header">
        <h1 class="events-title">
          <i class="fas fa-calendar"></i> Events
        </h1>
        
        <button class="btn-modern" onclick="toggleCreateForm()">
          <i class="fas fa-plus"></i> Create Event
        </button>
      </div>

      <!-- Create Event Form -->
      <div class="create-event-form" id="createEventContainer" style="display: none;">
        <h3 class="mb-4">
          <i class="fas fa-calendar-plus"></i> Create New Event
        </h3>
        
        <form method="post" action="/events" id="createEventForm">
          <div class="form-row">
            <div class="form-group">
              <label for="event_name">Event Name *</label>
              <input type="text" name="event_name" id="event_name" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label for="event_date">Event Date</label>
              <input type="date" name="event_date" id="event_date" class="form-input">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="event_time">Event Time</label>
              <input type="time" name="event_time" id="event_time" class="form-input">
            </div>
            
            <div class="form-group">
              <label for="venue">Venue Address *</label>
              <input type="text" name="venue" id="venue" class="form-input" placeholder="e.g., 55/A Rosewood Villa, Indiranagar, Bangalore" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="max_capacity">Maximum Capacity</label>
              <input type="number" name="max_capacity" id="max_capacity" class="form-input" min="1">
            </div>
            
            <div class="form-group">
              <label for="ticket_price">Ticket Price</label>
              <input type="number" name="ticket_price" id="ticket_price" class="form-input" min="0" step="0.01">
            </div>
          </div>
          
          <div class="form-group">
            <label for="description">Description</label>
            <textarea name="description" id="description" class="form-input" rows="3" placeholder="Describe your event..."></textarea>
          </div>
          
          <div class="form-group">
            <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 16px; display: block;">
              <i class="fas fa-user"></i> Organizer Contact Information
            </label>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="organizer_name">Organizer Name *</label>
              <input type="text" name="organizer_name" id="organizer_name" class="form-input" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
              <label for="organizer_phone">Phone Number *</label>
              <input type="tel" name="organizer_phone" id="organizer_phone" class="form-input" placeholder="+91 98765 43210" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="organizer_email">Email Address *</label>
            <input type="email" name="organizer_email" id="organizer_email" class="form-input" placeholder="your.email@example.com" required>
          </div>
          
          <div class="text-center">
            <button type="submit" class="btn-modern">
              <i class="fas fa-save"></i> Create Event
            </button>
            <button type="button" class="btn-modern btn-secondary" onclick="toggleCreateForm()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>

      {% if events %}
        {% for event in events %}
          <div class="event-card">
            <div class="event-header">
              <div>
                <h3 class="event-title">{{ event.name }}</h3>
                {% if event.date %}
                  <p class="event-date">
                    <i class="fas fa-calendar"></i> 
                    {% if event.date is string %}
                      {% if event.date|length == 10 and event.date[4] == '-' and event.date[7] == '-' %}
                        {# Convert YYYY-MM-DD to DDMMYYYY #}
                        {{ event.date[8:10] + event.date[5:7] + event.date[0:4] }}
                      {% else %}
                        {{ event.date }}
                      {% endif %}
                    {% else %}
                      {{ event.date.strftime('%d%m%Y') if event.date else 'No date set' }}
                    {% endif %}
                  </p>
                {% endif %}
                {% if event.description %}
                  <p class="text-secondary mt-2">{{ event.description }}</p>
                {% endif %}
              </div>
              
              <div class="event-actions">
                <a href="/dashboard?event={{ event.name }}" class="btn-event primary">
                  <i class="fas fa-home"></i> Manage
                </a>
                <a href="/list?event={{ event.name }}" class="btn-event secondary">
                  <i class="fas fa-list"></i> View Guests
                </a>
                <button class="btn-event secondary" onclick="editEvent('{{ event.id }}')">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn-event secondary" onclick="deleteEvent('{{ event.id }}')">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
            
            {% if event.stats %}
              <div class="event-stats">
                <div class="stat-item">
                  <div class="stat-number">{{ event.stats.total_tickets or 0 }}</div>
                  <div class="stat-label">Tickets</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">{{ event.stats.total_people or 0 }}</div>
                  <div class="stat-label">People</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">{{ event.stats.checked_in or 0 }}</div>
                  <div class="stat-label">Checked In</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">{{ event.stats.seats_left or 0 }}</div>
                  <div class="stat-label">Seats Left</div>
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="glass-card text-center">
          <div class="action-icon" style="margin-bottom: 24px;">
            <i class="fas fa-calendar-plus"></i>
          </div>
          <h3 class="mb-3">No Events Created</h3>
          <p class="text-secondary mb-4">Start by creating your first event to manage tickets and guests.</p>
          <button class="btn-modern" onclick="toggleCreateForm()">
            <i class="fas fa-plus"></i> Create Your First Event
          </button>
        </div>
      {% endif %}
    </main>
  </div>

  <!-- Edit Event Modal -->
  <div id="editEventModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> Edit Event</h2>
        <span class="close-btn" onclick="closeEditModal()">
          <i class="fas fa-times"></i>
        </span>
      </div>
      <div class="modal-body">
        <form id="editEventForm">
          <div class="form-row">
            <div class="form-group">
              <label for="edit_event_name">Event Name *</label>
              <input type="text" name="event_name" id="edit_event_name" class="form-input" required>
            </div>
            
            <div class="form-group">
              <label for="edit_event_date">Event Date</label>
              <input type="date" name="event_date" id="edit_event_date" class="form-input">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="edit_event_time">Event Time</label>
              <input type="time" name="event_time" id="edit_event_time" class="form-input">
            </div>
            
            <div class="form-group">
              <label for="edit_venue">Venue Address *</label>
              <input type="text" name="venue" id="edit_venue" class="form-input" placeholder="e.g., 55/A Rosewood Villa, Indiranagar, Bangalore" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="edit_max_capacity">Maximum Capacity</label>
              <input type="number" name="max_capacity" id="edit_max_capacity" class="form-input" min="1">
            </div>
            
            <div class="form-group">
              <label for="edit_ticket_price">Ticket Price</label>
              <input type="number" name="ticket_price" id="edit_ticket_price" class="form-input" min="0" step="0.01">
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit_description">Description</label>
            <textarea name="description" id="edit_description" class="form-input" rows="3" placeholder="Describe your event..."></textarea>
          </div>
          
          <div class="form-group">
            <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 16px; display: block;">
              <i class="fas fa-user"></i> Organizer Contact Information
            </label>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="edit_organizer_name">Organizer Name *</label>
              <input type="text" name="organizer_name" id="edit_organizer_name" class="form-input" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
              <label for="edit_organizer_phone">Phone Number *</label>
              <input type="tel" name="organizer_phone" id="edit_organizer_phone" class="form-input" placeholder="+91 98765 43210" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit_organizer_email">Email Address *</label>
            <input type="email" name="organizer_email" id="edit_organizer_email" class="form-input" placeholder="your.email@example.com" required>
          </div>
          
          <div class="text-center">
            <button type="submit" class="btn-modern">
              <i class="fas fa-save"></i> Update Event
            </button>
            <button type="button" class="btn-modern btn-secondary" onclick="closeEditModal()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentEventId = null;

    function toggleCreateForm() {
      const container = document.getElementById('createEventContainer');
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }

    function editEvent(eventId) {
      currentEventId = eventId;
      
      // Fetch event data
      fetch(`/get_event/${eventId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const event = data.event;
            
            // Populate form fields
            document.getElementById('edit_event_name').value = event.name || '';
            document.getElementById('edit_event_date').value = event.date || '';
            document.getElementById('edit_event_time').value = event.time || '';
            document.getElementById('edit_venue').value = event.venue || '';
            document.getElementById('edit_max_capacity').value = event.capacity || '';
            document.getElementById('edit_ticket_price').value = event.ticket_price || '';
            document.getElementById('edit_description').value = event.description || '';
            document.getElementById('edit_organizer_name').value = event.organizer_name || '';
            document.getElementById('edit_organizer_phone').value = event.organizer_phone || '';
            document.getElementById('edit_organizer_email').value = event.organizer_email || '';
            
                         // Show modal
             document.getElementById('editEventModal').style.display = 'block';
             
             // Add date formatting for edit modal
             const editDateInput = document.getElementById('edit_event_date');
             if (editDateInput) {
               editDateInput.addEventListener('change', function() {
                 const date = this.value;
                 if (date) {
                                    // Convert YYYY-MM-DD to DDMMYYYY for display
                 const parts = date.split('-');
                 if (parts.length === 3) {
                   const formattedDate = parts[2] + parts[1] + parts[0]; // DD + MM + YYYY
                   console.log('Edit Date conversion:', date, '->', formattedDate, '(parts:', parts, ')');
                   // Show formatted date in a tooltip or nearby element
                   const dateDisplay = document.createElement('div');
                     dateDisplay.style.cssText = `
                       position: absolute;
                       top: 100%;
                       left: 0;
                       background: var(--bg-card);
                       border: 1px solid var(--border-color);
                       border-radius: 8px;
                       padding: 8px 12px;
                       font-size: 12px;
                       color: var(--text-secondary);
                       z-index: 1000;
                       margin-top: 4px;
                     `;
                     dateDisplay.textContent = `Date: ${formattedDate}`;
                     
                     // Remove existing display
                     const existing = this.parentNode.querySelector('.date-display');
                     if (existing) existing.remove();
                     
                     dateDisplay.className = 'date-display';
                     this.parentNode.style.position = 'relative';
                     this.parentNode.appendChild(dateDisplay);
                     
                     // Remove display after 3 seconds
                     setTimeout(() => {
                       if (dateDisplay.parentNode) {
                         dateDisplay.remove();
                       }
                     }, 3000);
                   }
                 }
               });
             }
           } else {
             alert('Error loading event: ' + data.message);
           }
         })
         .catch(error => {
           console.error('Error:', error);
           alert('Error loading event data');
         });
     }

    function closeEditModal() {
      document.getElementById('editEventModal').style.display = 'none';
      currentEventId = null;
    }

    // Handle edit form submission
    document.getElementById('editEventForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentEventId) {
        alert('No event selected for editing');
        return;
      }
      
      const formData = new FormData(this);
      
      fetch(`/update_event/${currentEventId}`, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Event updated successfully!');
          closeEditModal();
          location.reload();
        } else {
          alert('Error updating event: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating event');
      });
    });

    function deleteEvent(eventId) {
      if (confirm('Are you sure you want to delete this event? This will also delete all associated tickets and data.')) {
        fetch(`/delete_event/${eventId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error deleting event: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error deleting event');
        });
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('editEventModal');
      if (event.target === modal) {
        closeEditModal();
      }
    }

    // Add active class to current page
    document.addEventListener('DOMContentLoaded', function() {
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll('.nav-item');
      
      navItems.forEach(item => {
        if (item.getAttribute('href') === currentPath) {
          item.classList.add('active');
        }
      });
      
      // Handle create event form submission
      const createForm = document.getElementById('createEventForm');
      if (createForm) {
        createForm.addEventListener('submit', function(e) {
          console.log('Create event form submitted');
          const formData = new FormData(this);
          
          // Log form data for debugging
          for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
          }
          
          // Let the form submit normally
        });
      }
      
      // Format date input to show DDMMYYYY format
      const dateInput = document.getElementById('event_date');
      if (dateInput) {
        dateInput.addEventListener('change', function() {
          const date = this.value;
          if (date) {
            // Convert YYYY-MM-DD to DDMMYYYY for display
            const parts = date.split('-');
            if (parts.length === 3) {
              const formattedDate = parts[2] + parts[1] + parts[0]; // DD + MM + YYYY
              console.log('Date conversion:', date, '->', formattedDate, '(parts:', parts, ')');
              // Show formatted date in a tooltip or nearby element
              const dateDisplay = document.createElement('div');
              dateDisplay.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 12px;
                color: var(--text-secondary);
                z-index: 1000;
                margin-top: 4px;
              `;
              dateDisplay.textContent = `Date: ${formattedDate}`;
              
              // Remove existing display
              const existing = this.parentNode.querySelector('.date-display');
              if (existing) existing.remove();
              
              dateDisplay.className = 'date-display';
              this.parentNode.style.position = 'relative';
              this.parentNode.appendChild(dateDisplay);
              
              // Remove display after 3 seconds
              setTimeout(() => {
                if (dateDisplay.parentNode) {
                  dateDisplay.remove();
                }
              }, 3000);
            }
          }
        });
      }
    });
  </script>
</body>
</html>
